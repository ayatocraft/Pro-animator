<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Animator Backup</title>
<link rel="manifest" href="manifest.json">
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
<style>
  body {
    margin: 0;
    background: #1e1e1e;
    color: #fff;
    font-family: "Segoe UI", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
  }

  h1 {
    font-size: 28px;
    margin-bottom: 20px;
  }

  .btn {
    background: linear-gradient(135deg, #4a90e2, #0078d7);
    border: none;
    border-radius: 10px;
    padding: 15px 25px;
    color: white;
    font-size: 16px;
    cursor: pointer;
    margin: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: 0.2s;
  }
  .btn:hover {
    background: linear-gradient(135deg, #5ba1f3, #0088f0);
    transform: translateY(-2px);
  }

  #loading {
    display: none;
    flex-direction: column;
    align-items: center;
    margin-top: 30px;
  }
  .spinner {
    border: 4px solid rgba(255,255,255,0.1);
    border-top: 4px solid #fff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  #message {
    margin-top: 20px;
    font-size: 14px;
    color: #aaa;
  }

  #back {
    position: fixed;
    top: 15px;
    left: 15px;
    background: rgba(255,255,255,0.1);
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    color: white;
    cursor: pointer;
  }
  #back:hover { background: rgba(255,255,255,0.2); }

</style>
</head>
<body>

<button id="back">â† æˆ»ã‚‹</button>
<h1>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†</h1>

<button class="btn" id="download">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
<button class="btn" id="upload">ğŸ“‚ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’èª­ã¿è¾¼ã¿</button>

<div id="loading">
  <div class="spinner"></div>
  <div id="message">ãŠå¾…ã¡ãã ã•ã„...</div>
</div>

<input type="file" id="fileInput" accept=".dat" style="display:none">

<script>
const loading = document.getElementById("loading");
const message = document.getElementById("message");
const username = localStorage.getItem("currentUser") || "guest";

/* ğŸ”™ æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
document.getElementById("back").onclick = () => {
  location.href = "home.html";
};

/* ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç† */
document.getElementById("download").onclick = async () => {
  try {
    const allData = {
      user: username,
      projects: JSON.parse(localStorage.getItem(`${username}_projects`) || "[]"),
      settings: JSON.parse(localStorage.getItem(`${username}_settings`) || "{}")
    };
    const blob = new Blob([JSON.stringify(allData)], { type: "application/octet-stream" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `animator-backup-${username}.dat`;
    a.click();
    URL.revokeObjectURL(url);
  } catch (err) {
    alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
  }
};

/* ğŸ“‚ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç† */
document.getElementById("upload").onclick = () => {
  document.getElementById("fileInput").click();
};

document.getElementById("fileInput").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;
  if (!file.name.endsWith(".dat")) {
    alert("æ­£ã—ã„å½¢å¼ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  const reader = new FileReader();
  reader.onload = async (event) => {
    try {
      loading.style.display = "flex";
      await new Promise(r => setTimeout(r, 1000)); // æ“¬ä¼¼ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
      const data = JSON.parse(event.target.result);

      if (!data.user || !data.projects) {
        throw new Error("å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
      }

      localStorage.setItem(`${username}_projects`, JSON.stringify(data.projects));
      localStorage.setItem(`${username}_settings`, JSON.stringify(data.settings || {}));

      loading.style.display = "none";
      alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
      location.href = "home.html";

    } catch (err) {
      loading.style.display = "none";
      alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err.message);
    }
  };
  reader.readAsText(file);
});
</script>
</body>
</html>
