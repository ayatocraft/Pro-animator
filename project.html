<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Animator Pro - Project</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0078d7">
<style>
body {
  margin: 0;
  font-family: "Segoe UI", "Noto Sans JP", sans-serif;
  background: #f5f7fa;
  display: flex;
  flex-direction: column;
  height: 100vh;
}
header {
  background: #0078d7;
  color: white;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
header button {
  background: white;
  color: #0078d7;
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  cursor: pointer;
  font-weight: bold;
}
canvas {
  flex: 1;
  border: 1px solid #ccc;
  background: white;
  touch-action: none;
}
.toolbar {
  display: flex;
  gap: 10px;
  padding: 8px;
  background: #fff;
  border-bottom: 1px solid #ddd;
  align-items: center;
}
.toolbar input[type="color"], .toolbar input[type="number"] {
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 4px;
}
.bottom-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fff;
  border-top: 1px solid #ddd;
  padding: 8px 12px;
}
#colorPickerPopup {
  position: absolute;
  top: 50px;
  right: 10px;
  background: white;
  padding: 12px;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  display: none;
}
#colorPickerPopup input[type="range"] {
  width: 100%;
}
</style>
</head>
<body>

<header>
  <div>ğŸ¨ Animator Pro</div>
  <button id="modeToggle">å†ç”Ÿãƒ¢ãƒ¼ãƒ‰</button>
</header>

<div class="toolbar">
  <label>å¤ªã•: <input type="number" id="penSize" value="3" min="1" max="50"></label>
  <button id="penTool">ğŸ–Šï¸ãƒšãƒ³</button>
  <button id="eraserTool">ğŸ©¹æ¶ˆã—ã‚´ãƒ </button>
  <button id="textTool">ğŸ”¤ãƒ†ã‚­ã‚¹ãƒˆ</button>
  <button id="colorButton">ğŸ¨è‰²</button>
  <div id="colorPickerPopup">
    <input type="color" id="penColor" value="#000000">
    <label>R: <input type="range" id="r" min="0" max="255"></label>
    <label>G: <input type="range" id="g" min="0" max="255"></label>
    <label>B: <input type="range" id="b" min="0" max="255"></label>
  </div>
  <button id="copyFrame">ğŸ“„ã‚³ãƒ”ãƒ¼</button>
  <button id="addFrame">â•è¿½åŠ </button>
</div>

<canvas id="canvas"></canvas>

<div class="bottom-bar">
  <div>
    <button id="prevFrame">â¬…ï¸</button>
    <span id="frameCounter">1/1</span>
    <button id="nextFrame">â¡ï¸</button>
  </div>
  <div id="playbackControls" style="display:none;">
    <button id="playBtn">â–¶ï¸</button>
    <button id="stopBtn">â¹ï¸</button>
    <label>é€Ÿåº¦:<input type="number" id="fpsInput" value="4" min="1" max="60">fps</label>
    <button id="exportBtn">ğŸ’¾MP4ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  </div>
</div>

<script>
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let drawing = false;
let frames = [ctx.getImageData(0,0,canvas.width,canvas.height)];
let currentFrame = 0;
let penColor = "#000";
let penSize = 3;
let tool = "pen";
let playing = false;

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 140;
  redrawFrame();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function redrawFrame() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(frames[currentFrame]) ctx.putImageData(frames[currentFrame], 0, 0);
}

canvas.addEventListener("pointerdown", e=>{
  if(tool==="text"){
    let text = prompt("å…¥åŠ›ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ:");
    if(text){
      ctx.font = `${penSize*5}px sans-serif`;
      ctx.fillStyle = penColor;
      ctx.fillText(text, e.offsetX, e.offsetY);
      saveFrame();
    }
    return;
  }
  drawing = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});
canvas.addEventListener("pointermove", e=>{
  if(!drawing) return;
  ctx.lineWidth = penSize;
  ctx.lineCap = "round";
  ctx.strokeStyle = tool==="eraser" ? "#fff" : penColor;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});
canvas.addEventListener("pointerup", ()=>{
  drawing = false;
  saveFrame();
});

function saveFrame(){
  frames[currentFrame] = ctx.getImageData(0,0,canvas.width,canvas.height);
  updateFrameCounter();
}

function updateFrameCounter(){
  document.getElementById("frameCounter").innerText = `${currentFrame+1}/${frames.length}`;
}

document.getElementById("penTool").onclick = ()=>tool="pen";
document.getElementById("eraserTool").onclick = ()=>tool="eraser";
document.getElementById("textTool").onclick = ()=>tool="text";
document.getElementById("penSize").oninput = e=>penSize=e.target.value;
document.getElementById("colorButton").onclick = ()=>{
  let popup = document.getElementById("colorPickerPopup");
  popup.style.display = popup.style.display==="block"?"none":"block";
};
document.getElementById("penColor").oninput = e=>penColor=e.target.value;

document.getElementById("addFrame").onclick = ()=>{
  frames.push(ctx.createImageData(canvas.width,canvas.height));
  currentFrame = frames.length-1;
  redrawFrame();
  updateFrameCounter();
};
document.getElementById("copyFrame").onclick = ()=>{
  frames.push(frames[currentFrame]);
  currentFrame = frames.length-1;
  redrawFrame();
  updateFrameCounter();
};
document.getElementById("prevFrame").onclick = ()=>{
  if(currentFrame>0){ currentFrame--; redrawFrame(); updateFrameCounter(); }
};
document.getElementById("nextFrame").onclick = ()=>{
  if(currentFrame<frames.length-1){ currentFrame++; redrawFrame(); updateFrameCounter(); }
};

// å†ç”Ÿãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
document.getElementById("modeToggle").onclick = ()=>{
  let playUI = document.getElementById("playbackControls");
  if(playUI.style.display==="none"){
    playUI.style.display="flex";
    document.getElementById("modeToggle").innerText="ç·¨é›†ãƒ¢ãƒ¼ãƒ‰";
  }else{
    playUI.style.display="none";
    document.getElementById("modeToggle").innerText="å†ç”Ÿãƒ¢ãƒ¼ãƒ‰";
  }
};

// å†ç”Ÿ
document.getElementById("playBtn").onclick = ()=>{
  playing = true;
  let fps = parseInt(document.getElementById("fpsInput").value);
  let i=0;
  let playInterval = setInterval(()=>{
    if(!playing){ clearInterval(playInterval); return; }
    ctx.putImageData(frames[i],0,0);
    i=(i+1)%frames.length;
  },1000/fps);
};
document.getElementById("stopBtn").onclick = ()=>playing=false;

// MP4ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
document.getElementById("exportBtn").onclick = async ()=>{
  let fps = parseInt(document.getElementById("fpsInput").value);
  let stream = canvas.captureStream(fps);
  let recorder = new MediaRecorder(stream, {mimeType:'video/webm'});
  let chunks = [];
  recorder.ondataavailable = e=>chunks.push(e.data);
  recorder.onstop = ()=>{
    let blob = new Blob(chunks, {type:'video/mp4'});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "animation.mp4";
    a.click();
  };
  recorder.start();
  let i=0;
  let playInterval = setInterval(()=>{
    ctx.putImageData(frames[i],0,0);
    i++;
    if(i>=frames.length){ clearInterval(playInterval); recorder.stop(); }
  },1000/fps);
};
</script>
</body>
</html>
